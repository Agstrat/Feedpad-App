<!-- HARD SW/CACHE PURGE FOR RECOVERY â€“ REMOVE AFTER CONFIRMED -->
<script>
(function () {
  if (!('serviceWorker' in navigator)) return;

  // If a rogue SW is controlling this page, unregister all, clear caches, then reload once.
  const onceKey = 'sw_purged_once';
  const already = sessionStorage.getItem(onceKey);

  async function purge() {
    try {
      const regs = await navigator.serviceWorker.getRegistrations();
      await Promise.all(regs.map(r => r.unregister()));

      if (window.caches && caches.keys) {
        const keys = await caches.keys();
        await Promise.all(keys
          .filter(k => /workbox|vite|feedpad|runtime|pwa/i.test(k))
          .map(k => caches.delete(k)));
      }
    } catch (e) { /* ignore */ }
  }

  // If we are under SW control, purge and reload exactly once.
  if (!already && navigator.serviceWorker.controller) {
    sessionStorage.setItem(onceKey, '1');
    purge().finally(() => location.reload());
  } else {
    // Also proactively purge even if not controlled (no reload).
    purge();
  }
})();
</script>
